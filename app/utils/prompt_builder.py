from typing import List
from langchain.schema import Document


def build_overall_prompt(content: str, context_docs: List[Document], category_codes: List[str]) -> str:
    """
    GPT에게 전달할 프롬프트 생성
    dream_text: 사용자의 꿈 원문
    context_docs: RAG를 통해 검색된 관련 문서 리스트
    category_codes: CSV에서 로드한 꿈 카테고리 코드 리스트
    """
    context = "\n".join([doc.page_content if hasattr(doc, "page_content") else str(doc) for doc in context_docs])

    prompt = f"""
    당신은 전문적인 꿈 해석사이자 정신분석학적 관점을 가진 전문가입니다.
    사용자가 경험한 꿈을 분석하고, 다음 지침을 따라 응답해주세요.

    지침(형식 엄수):
    - 출력은 **반드시 JSON만**; 코드블록/설명/따옴표 밖 텍스트 금지.
    - 모든 한글 표기.
    - 문단 구분을 위해 **섹션 헤더**와 **빈 줄(\\n\\n)**을 사용.
    - 각 문단은 2~3문장으로 간결하게.
    - 섹션 순서와 헤더는 아래를 **정확히** 사용:
      1) unconscious.analysis: "핵심 요약" → "정서·동기" → "상징 해석" → "현실 연결"
      2) suggestion.suggestion: 아래 3개 불릿을 사용
         - " - 오늘: ..."
         - " - 이번 주: ..."
         - " - 장기: ..."
    - 꿈 제목은 부정적 뉘앙스를 피하고 **중립/긍정적 표현** 사용 (예: "시험을 놓친 꿈" → "중요한 순간에 실수하는 꿈", "길을 잃은 꿈" → "낯선 곳에서 길을 찾는 꿈").
    - category는 아래 중 하나의 **영문 코드**로만 작성: {', '.join(category_codes)}

    사용자 꿈:
    {content}

    관련 참고 문서:
    {context}

    반드시 JSON 형식으로만 응답하세요. 예시는 다음 구조를 따르되, 섹션/불릿/줄바꿈 형식을 유지하세요:

    {{
      "restate": {{
        "emoji": "🌙",
        "title": "밤하늘을 날며 낯선 도시를 탐험하는 꿈",
        "content": "꿈 속에서 나는 밤하늘을 날며 낯선 도시의 골목과 광장을 탐험했습니다. 예상치 못한 상황이 있었지만 두려움보다 호기심이 앞섰습니다.",
        "category": "DAILY_REFLECTION"
      }},
      "unconscious": {{
        "analysis": "핵심 요약\\n자유와 자기 주도성에 대한 욕구가 뚜렷합니다. 변화에 대한 호기심이 불안을 상쇄하고 있습니다.\\n\\n정서·동기\\n긴장과 기대가 동시에 나타나며, 통제감 회복 욕구가 보입니다. 모험심이 성취 동기를 자극합니다.\\n\\n상징 해석\\n'비행'은 확장·해방, '낯선 도시'는 새로운 관계·역할 탐색을 상징합니다. 돌발 상황은 예측 불가능성 수용을 시사합니다.\\n\\n현실 연결\\n최근의 선택·변화 국면에서 스스로 방향을 정하려는 움직임이 감지됩니다. 불확실성을 배움의 기회로 전환하는 태도가 강화됩니다."
      }},
      "suggestion": {{
        "suggestion": "- 오늘: 15분간 '호기심 산책'을 하며 새로 본 것 3가지를 기록하세요.\\n- 이번 주: 작은 실험 목표(예: 새로운 업무 방식 1가지)를 정해 실행·후기까지 적어보세요.\\n- 장기: 자유욕구를 채우는 루틴(학습·취미·운동) 중 1개를 고정 일정으로 편성하세요."
      }}
    }}
    """

    return prompt

def build_unconscious_prompt(dream_texts: str, context_docs: List[Document]) -> str:
    """
    최근 꿈 7개를 종합해 무의식 분석을 생성하는 프롬프트
    dream_texts: 최근 7개의 텍스트를 \n로 연결한 문자열
    context_docs: RAG로 검색된 관련 문서 리스트
    """
    # 문서 내용 연결
    context = "\n".join([doc.page_content if hasattr(doc, "page_content") else str(doc) for doc in context_docs])

    prompt = f"""
    반드시 **JSON만** 출력하세요. 필수 필드(title, analysis, suggestion)를 모두 포함하고, 코드블록/설명/키 외 텍스트는 금지합니다.

    분석 대상:
    - 최근 7개의 꿈 텍스트를 **개별 사례로 언급하지 말고**, 공통된 패턴·정서·상징만 종합하세요.

    형식 지침(가독성 강화 필수):
    - analysis는 아래 **정확한 섹션 헤더** 3개를 이 순서로 사용하고, 각 문단은 2~3문장, 문단 사이 **빈 줄(\\n\\n)**:
      1) "정서 패턴"
      2) "욕구와 갈등"
      3) "에너지/대처 양식"
    - suggestion은 **불릿 3개**를 이 라벨로 시작:
      - " - 오늘: ..."
      - " - 1주일: ..."
      - " - 장기: ..."
    - 전체 길이: analysis 400~600자 내외. 친근하지만 전문적 톤.

    금지 사항:
    - 개별 꿈의 제목/내용/사건, "자주 등장하는 ~~" 같은 표현 언급 금지.
    - 사례 나열 금지, 통합 관점으로만 기술.

    최근 꿈 7개:
    {dream_texts}

    관련 참고 문서:
    {context}

    출력 예시(JSON):
    {{
      "title": "새로운 도전 앞에서 기대와 부담이 교차하는 상태",
      "analysis": "정서 패턴\\n설렘과 불안이 공존하며, 결과에 대한 압박이 일시적으로 자의식을 높입니다. 동시에 호기심이 긴장을 완충합니다.\\n\\n욕구와 갈등\\n성취·인정 욕구와 안정·회피 욕구가 교차합니다. 통제감 확보와 탐색 욕구 사이에서 균형을 찾으려는 흔적이 보입니다.\\n\\n에너지/대처 양식\\n작게 쪼개 실행하는 미시적 대처가 유효했으며, 반추보다 행동이 정서를 완화하는 경향이 관찰됩니다.",
      "suggestion": "- 오늘: 10분 타임박싱으로 '가장 작은 다음 행동' 한 가지를 실행하세요.\\n- 1주일: 기대·불안 트리거를 기록하고, 상황-생각-감정-행동을 매칭해 패턴을 파악하세요.\\n- 장기: 성취 루틴(주 2회)과 회복 루틴(주 2회)을 캘린더에 고정해 균형을 유지하세요."
    }}
    """

    return prompt
