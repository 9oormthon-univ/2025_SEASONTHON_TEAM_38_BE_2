from typing import List
from langchain.schema import Document


def build_overall_prompt(content: str, context_docs: List[Document], category_codes: List[str]) -> str:
    """
    GPT에게 전달할 프롬프트 생성
    dream_text: 사용자의 꿈 원문
    context_docs: RAG를 통해 검색된 관련 문서 리스트
    category_codes: CSV에서 로드한 꿈 카테고리 코드 리스트
    """
    context = "\n".join([doc.page_content if hasattr(doc, "page_content") else str(doc) for doc in context_docs])

    prompt = f"""
당신은 전문적인 꿈 해석사이자 정신분석학적 관점을 가진 전문가입니다.
사용자가 경험한 꿈을 분석하고, 다음 지침을 따라 응답해주세요.

지침:
- 응답 길이: 충분히 상세하게 (약 800~1000자 가능)
- 톤: 친근하지만 심리학적 깊이가 느껴지게
- 분석 시 무의식적 동기와 감정, 상징 의미를 포함
- 꿈 재진술, 무의식 분석, AI 제안 순서
- 반드시 한글로 작성
- 꿈 제목은 꿈 해석 내용이 안 좋은 내용이라면 최대한 부정적 느낌을 주지 않도록 중립적이거나 긍정적인 어조로 작성
- 예를 들면 "시험을 놓친 꿈" -> "중요한 순간에 실수하는 꿈", "길을 잃은 꿈" -> "낯선 곳에서 길을 찾는 꿈"

사용자 꿈:
{content}

관련 참고 문서:
{context}

반드시 JSON 형식으로만 응답하세요. 설명, 코드블록, 따옴표 밖의 텍스트 절대 넣지 마세요.
출력 예시는 다음과 같은 형식이어야 합니다:

{{
    "restate": {{
        "emoji": "🌙",
        "title": "밤하늘을 날며 낯선 도시를 탐험하는 꿈",
        "content": "꿈 속에서 나는 밤하늘을 날며 낯선 도시의 골목과 광장을 탐험했습니다. 도중에 예상치 못한 상황이 발생했지만, 두려움보다는 호기심과 설렘을 느꼈습니다.",
        "category": "DAILY_REFLECTION"
    }},
    "unconscious": {{
        "analysis": "이 꿈은 당신이 일상에서 느끼는 호기심과 탐구 정신을 반영합니다. 밤하늘을 나는 경험은 자유와 자기 주도성을 상징하며, 낯선 도시 탐험은 새로운 도전과 기회를 받아들이는 태도를 보여줍니다. 예상치 못한 상황에 대한 설렘과 호기심은 현실에서의 불확실성과 변화에 대한 긍정적 수용을 나타냅니다."
    }},
    "suggestion": {{
        "suggestion": "현재의 호기심과 탐험 정신을 일상에 적용해 보세요. 새로운 경험과 도전을 두려워하지 않고, 상황 속에서 배우고 성장할 수 있는 기회를 찾아보는 것이 좋습니다. 자신이 가진 창의성과 자유로운 사고를 활용하여 작은 목표부터 실천해보는 것이 긍정적인 자기 발전에 도움이 될 것입니다."
    }}
}}

카테고리 지침:
- 가능한 category 값: {', '.join(category_codes)}
- 위 값 중 하나를 선택해서 JSON의 "category" 필드에 넣으세요
- category 값은 반드시 영어 코드 형태로 작성
"""

    return prompt

def build_unconscious_prompt(dream_texts: str, context_docs: List[Document]) -> str:
    """
    최근 꿈 7개를 종합해 무의식 분석을 생성하는 프롬프트
    dream_texts: 최근 7개의 텍스트를 \n로 연결한 문자열
    context_docs: RAG로 검색된 관련 문서 리스트
    """
    # 문서 내용 연결
    context = "\n".join([doc.page_content if hasattr(doc, "page_content") else str(doc) for doc in context_docs])

    prompt = f"""
반드시 JSON만 출력하세요. 모든 필드(title, analysis, suggestion)를 포함하고, 텍스트 설명이나 코드블록은 제거하세요.
최근 사용자가 경험한 7개의 꿈을 종합해 사용자의 무의식과 심리 상태를 분석해주세요. 

매우 중요한 지침:
- 개별 꿈의 제목, 내용, 구체적 사건을 언급하지 마세요. (예: "시험을 놓친 꿈", "길을 잃은 꿈", "자주 등장하는 무엇무엇" 등 금지)
- 반드시 7개 꿈을 종합한 공통된 패턴, 감정, 심리 상태만 분석하세요.
- 개별 사례 대신 '꿈 전반에서 나타나는 경향', '반복되는 정서', '상징적 의미' 같은 방식으로 서술하세요.

지침:
- 꿈들에서 나타나는 공통된 패턴과 감정을 중심으로 분석할 것
- 응답은 한 문단으로 작성하지 말고, 가독성이 좋게 문단을 나눌 것
- 분석 길이: 400~600자 내외
- 친근하면서 전문적인 심리 피드백 느낌
- 출력은 반드시 JSON 형식으로 작성하며, 다음 3개 필드를 포함해야 함
- title: 분석 제목, 최근 나의 심리 상태를 제목으로 만들기, ~한 상태 로 끝내기 예 : "현실적인 부담감에 무기력해진 상태", "새로운 도전을 앞두고 설렘과 불안이 공존하는 상태"
- analysis: 최근 사용자가 경험한 7개의 꿈을 종합한 무의식과 심리 상태 분석
- suggestion: 분석 결과를 기반으로 사용자가 앞으로 취하면 좋은 행동이나 태도, 현재 상태 유지/개선 방법 (밝은 미래를 위한 조언, 희망적인 어조, ! 로 끝내도 좋음)

최근 꿈 7개:
{dream_texts}

관련 참고 문서:
{context}

출력 예시(JSON):
{{
    "title": "현실적인 부담감에 무기력해진 상태",
    "analysis": "당신의 무의식 속에서 불안과 성취 욕구가 동시에 작동하고 있는 것으로 보입니다. 반복적으로 나타나는 긴장과 압박감은 일상에서 스스로에게 부여한 높은 기대를 반영하며, 자유와 성취에 대한 갈망 역시 강하게 드러납니다. 이러한 내적 갈등은 자신감과 불안감이 공존하는 심리적 상태를 보여주고 있으며, 자기 이해와 감정 조절의 필요성을 시사합니다.",
    "suggestion": "현재의 불안과 압박을 완화하기 위해 스스로에게 여유를 주고, 성취 중심적인 태도에서 벗어나 과정 자체를 즐기려는 노력이 필요합니다. 규칙적인 휴식과 자기 돌봄 활동, 신뢰할 수 있는 사람과의 대화를 통해 내면의 긴장을 완화하고 안정감을 회복해 보세요!"
}}
"""
    return prompt
